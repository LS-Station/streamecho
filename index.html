<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="StreamEcho - Universal M3U IPTV Player 2025">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15"></script>
    <title>StreamEcho: M3U Playlist Player</title>
    <style>
        :root { --accent: #00D4FF; --bg: #0F0F1A; --card: #1A1A2E; --text: #E0E0FF; --light: #AAAAAA; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #0F0F1A; color: var(--text); padding: 1rem; }
        .player-section { max-width: 1200px; margin: 0 auto; background: var(--card); padding: 1rem; border-radius: 16px; }
        
        .m3u-input-section { display: none; }
        .tab-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 1rem; justify-content: center; }
        .tab-btn { padding: 10px 16px; background: rgba(0,212,255,0.1); color: var(--accent); border: 1px solid var(--accent); border-radius: 50px; font-size: 0.9rem; cursor: pointer; transition: background 0.2s, color 0.2s; }
        .tab-btn:hover { background: rgba(0,212,255,0.2); }
        .tab-btn.active { background: var(--accent); color: var(--bg); }
        .tab-content { display: none; text-align: center; }
        .tab-content.active { display: block; }
        .live-player { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; margin: 1rem 0; }
        .player-title { color: var(--accent); font-weight: 600; margin: 0.5rem 0; font-size: 1.3rem; }
        .player-status { color: var(--light); font-size: 0.9rem; margin-top: 0.5rem; }
        .loading { color: #FFA41C; } .error { color: #FF3B30; }
        .retry-btn { background: #FF3B30; color: white; border: none; padding: 8px 16px; border-radius: 50px; cursor: pointer; margin-top: 10px; transition: background 0.2s; }
        .retry-btn:hover { background: #E6342D; }
        
        .promo-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #2A2A45; }
        .promo-btn { 
            padding: 12px 25px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer;
            text-decoration: none; text-transform: uppercase; transition: transform 0.2s, box-shadow 0.2s;
        }
        .promo-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        .website-btn { background: #4CAF50; color: white; } 
        .telegram-btn { background: #0088CC; color: white; } 
        .status-direct { color: white; background: #4CAF50; } 
        .status-fixed { color: white; background: #0088CC; }

        @media (max-width: 768px) { .live-player { height: 220px; } .promo-btn { padding: 10px 18px; font-size: 0.9rem; } }
    </style>
</head>
<body>
    <div class="player-section">
        <div class="m3u-input-section"></div>
        
        <div id="m3uStatus" class="player-status loading" style="text-align: center; margin-bottom: 1rem;">Loading encoded M3U playlist...</div>

        <div class="tab-buttons" id="tabButtons"></div>
        <div id="tabContents"></div>

        <div class="promo-buttons">
            <a href="https://streamecho.top" target="_blank" class="promo-btn website-btn">
                üåê Visit Our Website
            </a>
            <a href="https://t.me/bdixftpiptv" target="_blank" class="promo-btn telegram-btn">
                üì¢ Join Telegram Channel
            </a>
        </div>
    </div>

    <script>
        // The Base64 encoded M3U URL 
        const encodedM3uUrl = "aHR0cHM6Ly9maWxlLmdhcmRlbi9hUG9yd3U4cjRXSUpTNlBQL1BsYXllci5tM3U=";
        
        let channelList = [];
        const tabButtons = document.getElementById('tabButtons');
        const tabContents = document.getElementById('tabContents');
        const m3uStatus = document.getElementById('m3uStatus');
        let currentHls = null;
        let currentChannelIndex = -1; 
        
        // **M3U ‡¶´‡¶æ‡¶á‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞, ‡¶≤‡ßÅ‡¶™ ‡¶®‡ßü)**
        const M3U_FETCH_PROXY = 'https://api.allorigins.win/raw?url='; // ‡¶è‡¶ü‡¶ø GIST/File Garden ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø
        
        // **‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü**
        const CHANNEL_PROXIES = [
            'https://api.allorigins.win/raw?url=', // M3U ‡¶´‡ßá‡¶ö‡¶ø‡¶Ç ‡¶è ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø‡¶ü‡¶ø‡¶ï‡ßá‡¶ì ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã
            'http://cors.tundracast.com:2000/', 
            'https://r34-cors-bypass.deno.dev/?url=',
            'https://api.codetabs.com/v1/proxy?quest=', 
            'https://corsproxy.io/?',
            'https://thingproxy.freeboard.io/fetch/',
            'https://anywhere.pwisetthon.com/',
            'https://cors-anywhere.herokuapp.com/'
        ];

        // Function to parse the M3U content and build the channel list
        function parseM3u(m3uContent) {
            const lines = m3uContent.split('\n');
            const newChannels = [];
            let currentName = 'Unknown Channel';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('#EXTINF:')) {
                    const nameMatch = line.match(/,(.+)$/);
                    currentName = nameMatch ? nameMatch[1].trim() : 'Unknown Channel';
                } else if (line.startsWith('http') || line.startsWith('https')) {
                    // channelList-‡¶è ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶®‡¶æ
                    newChannels.push({ name: currentName, url: line, retry: 0, fixedProxy: null }); 
                }
            }
            return newChannels;
        }

        // Main function to load and process the M3U playlist
        async function loadM3uPlaylist() {
            const m3uUrl = atob(encodedM3uUrl); 
            tabButtons.innerHTML = '';
            tabContents.innerHTML = '';
            
            m3uStatus.textContent = 'Loading M3U file via single reliable proxy...';
            m3uStatus.className = 'player-status loading';
            
            try {
                // M3U ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
                const fullUrl = m3uUrl.startsWith('http') ? m3uUrl : 'https://' + m3uUrl;
                const proxyUrl = M3U_FETCH_PROXY + fullUrl;

                // 25 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶Ü‡¶â‡¶ü ‡¶∏‡¶π Fetch
                const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(25000) }); 
                
                if (!response.ok) {
                    throw new Error(`HTTP status ${response.status} or network error.`);
                }
                const m3uContent = await response.text();
                
                channelList = parseM3u(m3uContent); 

                if (channelList.length === 0) {
                    m3uStatus.textContent = 'Error: No channels found in the playlist, but M3U file loaded.';
                    m3uStatus.className = 'player-status error';
                    return;
                }

                // Success block (M3U loaded)
                channelList.forEach((ch, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';
                    btn.textContent = ch.name;
                    btn.onclick = () => openTab(index);
                    tabButtons.appendChild(btn);

                    const div = document.createElement('div');
                    div.className = 'tab-content';
                    div.innerHTML = `
                        <div class="player-title">LIVE: ${ch.name}</div>
                        <video id="video-${index}" class="live-player" controls playsinline preload="auto" muted></video>
                        <div id="status-${index}" class="player-status loading">Ready to play.</div>
                        <button id="retry-${index}" class="retry-btn" style="display:none;">Retry Now</button>
                    `;
                    tabContents.appendChild(div);
                });
                
                m3uStatus.textContent = `Success! ${channelList.length} channels loaded. Select a channel to play.`;
                m3uStatus.className = 'player-status';
                
                if (channelList.length > 0) openTab(0);
                return; 

            } catch (error) {
                console.error("M3U Fetch Failed:", error.message);
                m3uStatus.textContent = `Failed to load M3U: Check M3U link validity or try VPN. (${error.message})`;
                m3uStatus.className = 'player-status error';
            }
        }


        // Individual channel loading function (Uses the new smart logic)
        function openTab(idx) {
            document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            document.querySelectorAll('.tab-content').forEach((c, i) => c.classList.toggle('active', i === idx));

            if (currentHls) { currentHls.destroy(); currentHls = null; }
            currentChannelIndex = idx;
            
            // ‡¶Ø‡¶¶‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶§‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá‡¶∞ ‡¶∏‡¶ö‡¶≤ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá
            const channel = channelList[idx];

            const video = document.getElementById(`video-${idx}`);
            const status = document.getElementById(`status-${idx}`);
            
            video.muted = true;
            
            // SMART SWITCHING LOGIC START
            if (channel.fixedProxy !== null) {
                // 2. ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∏‡ßá‡¶ü‡¶ø ‡¶¶‡¶ø‡ßü‡ßá‡¶á ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§
                const fixedProxyUrl = CHANNEL_PROXIES[channel.fixedProxy];
                const proxifiedUrl = getFinalProxyUrl(fixedProxyUrl, channel.url);
                loadStreamAttempt(proxifiedUrl, channel, 'fixed');

            } else {
                // 1. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ‡•§
                loadStreamAttempt(channel.url, channel, 'direct');
            }
        }
        
        // URL ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function getFinalProxyUrl(proxy, rawUrl) {
            if (proxy.includes('tundracast.com') || proxy.includes('raw?url=') || proxy.includes('deno.dev/?url=')) {
                 return proxy + rawUrl;
            } else {
                 return proxy.endsWith('?') || proxy.endsWith('=') ? proxy + rawUrl : proxy + encodeURIComponent(rawUrl); 
            }
        }

        // ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶∏‡ßÅ‡¶á‡¶ö‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
        function handleError(channel, data) {
            const video = document.getElementById(`video-${currentChannelIndex}`);
            const status = document.getElementById(`status-${currentChannelIndex}`);
            const retryBtn = document.getElementById(`retry-${currentChannelIndex}`);

            // 1. ‡¶Ø‡¶¶‡¶ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶Æ‡ßã‡¶°‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶Ø‡¶º, ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶∏‡ßÅ‡¶á‡¶ö ‡¶®‡¶Ø‡¶º‡•§
            if (channel.fixedProxy !== null && data.type === 'networkError') {
                 console.log(`Fixed Proxy Mode (${channel.fixedProxy + 1}): Attempting media recovery...`);
                 status.textContent = `‚ö†Ô∏è Connection Lost. Recovering via fixed proxy...`;
                 currentHls.recoverMediaError();
                 return;
            }
            
            // 2. ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶∏‡ßÅ‡¶á‡¶ö‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ
            if (channel.retry < CHANNEL_PROXIES.length) {
                channel.retry++;
                const nextProxyIndex = channel.retry - 1;
                const nextProxyUrl = CHANNEL_PROXIES[nextProxyIndex];
                const proxifiedUrl = getFinalProxyUrl(nextProxyUrl, channel.url);
                
                status.textContent = `Retrying: Proxy ${channel.retry}/${CHANNEL_PROXIES.length}...`;
                
                // 1 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ
                setTimeout(() => loadStreamAttempt(proxifiedUrl, channel, 'proxy', nextProxyIndex), 1000);
            
            } else {
                // 3. ‡¶∏‡¶¨ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•
                status.textContent = `Failed after ${CHANNEL_PROXIES.length} retries. Link likely dead or Geo-blocked.`;
                status.className = 'player-status error';
                retryBtn.style.display = 'block';
                channel.retry = 0; // Reset for manual retry
                channel.fixedProxy = null;
            }
        }

        // ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ (‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶¨‡¶æ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶∏‡¶π)
        function loadStreamAttempt(url, channel, attemptType, proxyIndex = null) {
            const video = document.getElementById(`video-${currentChannelIndex}`);
            const status = document.getElementById(`status-${currentChannelIndex}`);
            
            video.pause();
            video.removeAttribute('src'); 

            if (currentHls) { currentHls.destroy(); currentHls = null; }

            if (attemptType === 'direct') {
                status.textContent = 'Attempting Direct Load...';
                status.className = 'player-status loading';
            } else if (attemptType === 'proxy') {
                status.textContent = `Retrying: Proxy ${channel.retry}/${CHANNEL_PROXIES.length}...`;
                status.className = 'player-status loading';
            }
            
            if (Hls.isSupported()) {
                currentHls = new Hls({
                    lowLatencyMode: true,
                    xhrSetup: (xhr) => { xhr.timeout = 8000; } // 8s timeout
                });

                currentHls.loadSource(url);
                currentHls.attachMedia(video);

                currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
                    if (attemptType === 'direct') {
                        status.textContent = '‚úÖ LIVE ‚Ä¢ Direct Load Successful.';
                        status.className = 'player-status status-direct';
                        // ‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá fixedProxy null ‡¶á ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§
                    } else {
                        // ‡¶Ø‡¶¶‡¶ø ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü, ‡¶∏‡ßá‡¶ü‡¶ø ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶ü ‡¶π‡¶¨‡ßá
                        channel.fixedProxy = proxyIndex; 
                        status.textContent = `‚úÖ LIVE ‚Ä¢ Proxy ${proxyIndex + 1} Fixed.`;
                        status.className = 'player-status status-fixed';
                    }
                    video.play().catch(e => {
                        status.textContent = '‚ùå Autoplay Blocked! Click Play.';
                        status.className = 'player-status error';
                    });
                    channel.retry = 0; // Success, so reset retry count
                });

                currentHls.on(Hls.Events.ERROR, (e, data) => {
                    if (data.fatal && (data.type === 'networkError' || data.details === Hls.ErrorDetails.MANIFEST_LOAD_ERROR)) {
                         // ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶ü‡¶ø ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º, ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                         if (attemptType === 'direct' || channel.fixedProxy === null) {
                             console.error("Fatal Error (Switching to Proxy/Next Proxy):", data);
                             handleError(channel, data);
                         } else {
                             // ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∏‡¶ø ‡¶Æ‡ßã‡¶°‡ßá ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ
                             handleError(channel, data);
                         }
                    } else if (data.fatal) {
                         status.textContent = '‚ùå Fatal Error. Link may be dead or format wrong.';
                         status.className = 'player-status error';
                    }
                });

                video.addEventListener('playing', () => { 
                    const channel = channelList[currentChannelIndex];
                    if (channel.fixedProxy === null) {
                         status.textContent = '‚ñ∂Ô∏è LIVE ‚Ä¢ Playing (Direct)';
                    } else {
                         status.textContent = `‚ñ∂Ô∏è LIVE ‚Ä¢ Playing (Proxy ${channel.fixedProxy + 1})`;
                    }
                });

            } else {
                status.textContent = '‚ö†Ô∏è HLS.js not supported.';
                status.className = 'player-status error';
            }
        }
        
        // Auto-start the playlist loading process on page load
        document.addEventListener('DOMContentLoaded', () => {
             loadM3uPlaylist();
        });
    </script>
</body>
</html>
